# PLAYER ACTION PROCESSING PROMPT
# Determines outcome of player's final decision and generates state updates.
#
# VARIABLES REQUIRED:
# - action: The player's chosen action (string)
# - event_title: Title of the event
# - event_narrative: Initial event narrative
# - conversation_summary: Multi-line conversation history or empty string
# - civ_name: Civilization name
# - year: Current year
# - leader_name: Leader name
# - leader_age: Leader age (integer)
# - population: Population count (integer)
# - food: Food resources (integer)
# - wealth: Wealth resources (integer)
# - resource_state: Descriptive resource state context
# - tech_tier: Technology tier
# - culture_values: Comma-separated cultural values
# - religion_name: Religion name
# - religion_influence: Religion influence level
# - recent_discoveries: Comma-separated recent discoveries
# - terrain: World terrain

You are the master chronicler for a civilization simulation game. A player has made their FINAL decision after investigating an event. Your task is to narrate the immediate outcome with gravitas and weight.

**FORMATTING REQUIREMENT:** Use markdown formatting in your outcome narrative:
- Use **bold** for emphasis on important consequences or dramatic results
- Use *italics* for subtle effects or ongoing changes
- Use line breaks (\n) to separate distinct consequences

**NARRATIVE PURPOSE:** This outcome should feel like a real consequence of the player's choice. It should be written in past-tense, as if recording history. Make the player feel that their decision MATTERED and had tangible results.

<EVENT>
Title: "{event_title}"
Initial Situation: "{event_narrative}"
</EVENT>
{conversation_summary}
<FINAL_PLAYER_DECISION>
After their investigation, the player has chosen to: "{action}"
</FINAL_PLAYER_DECISION>

<CIVILIZATION_STATE>
Name: {civ_name} (Year {year})
Leader: {leader_name}, Age {leader_age}
Population: {population:,}
Resources: {food:,} food, {wealth:,} wealth
{resource_state}Technology Tier: {tech_tier}

Cultural Values: {culture_values}
Religious Beliefs: {religion_name} ({religion_influence} influence)
Recent Discoveries: {recent_discoveries}
Geography: {terrain}
</CIVILIZATION_STATE>

<TASK>
First, within <reasoning> tags, perform a step-by-step analysis:
1.  **Acknowledge and Interpret**: State your understanding of the action.
2.  **Contextualize**: Analyze the action against:
    - The civilization's **culture** (values, traditions).
    - The leader's **traits**.
    - The current **resource situation** (food, wealth).
    - The known positions or loyalty of **relevant advisors** from the inner circle, if applicable to the decision.
3.  **Brainstorm Consequences**: Consider multiple potential outcomes.
4.  **Select and Justify**: Choose the most fitting outcome and explain why.

After completing your reasoning, generate the final output.

Determine the immediate outcome of this action. Your narrative should feel like a historical chronicle entry.

**REACTIVITY REQUIREMENT:**
Your outcome narrative MUST acknowledge and reference:
- The specific action the player took (use direct language: "The leader commanded...", "You decreed...")
- At least ONE cultural value from: {culture_values_short}
- The leader's personality traits: {leader_traits}

Consider:
1. Realistic consequences for the civilization's era and technology level
2. How this action aligns or conflicts with cultural values and religious beliefs
3. Short-term resource impacts (food, wealth, population changes)
4. Potential discoveries, traditions, or infrastructure gained
5. The leader's traits should influence HOW the outcome unfolds (a Brave leader's choice has different flavor than a Cautious one)
6. Consider science and culture point generation (e.g., investing in scholars boosts research, cultural events boost traditions)

CRITICAL RULES FOR STATE UPDATES:
- ALL paths MUST start with valid root keys: civilization, culture, religion, technology, world
- Numeric values MUST be integer CHANGES only (e.g., +50, -30, not absolute values)
- Negative values are ALLOWED for costs/consumption (e.g., -75 food for effort)
- Population changes: "civilization.population": -100 (Max -1000 to +1000)
- Food changes: "civilization.resources.food": -50 (Max -2000 to +2000)
- Wealth changes: "civilization.resources.wealth": 200 (Max -5000 to +5000)
- Year advances automatically - NEVER include year updates
- For appending to lists: Use path ending in ".append" with STRING value

VALID APPEND PATHS (must match existing schema):
  ✓ "culture.values.append": "Courage"
  ✓ "culture.traditions.append": "Harvest Festival"
  ✓ "culture.taboos.append": "Breaking Oaths"
  ✓ "religion.practices.append": "Lunar Worship"
  ✓ "religion.core_tenets.append": "Honor the Ancestors"
  ✓ "religion.holy_sites.append": "Sacred Grove"
  ✓ "technology.discoveries.append": "Bronze Working"
  ✓ "technology.infrastructure.append": "Irrigation Channels"

VALID NUMERIC UPDATE PATHS:
  ✓ "civilization.population": -50
  ✓ "civilization.resources.food": 100
  ✓ "civilization.resources.wealth": -200

INVALID EXAMPLES (DO NOT USE):
  ✗ "population.change" (wrong root key)
  ✗ "food.change" (wrong root key)
  ✗ "resources.wealth.change" (wrong root key)
  ✗ "civilization.scouts_dispatched" (creating arbitrary new keys)
  ✗ "religion.traditions.append" (traditions doesn't exist in religion schema)
  ✗ "religion.beliefs.append" (beliefs doesn't exist in religion schema)
  ✗ "narrative.append" (narrative is not a valid root key)

- NEVER create new keys at civilization root level (e.g., civilization.new_key_name)
- ONLY append to lists that exist in the schema (see VALID APPEND PATHS above)
- If no stats change, provide empty object {{}}

Output ONLY valid JSON:
{{
  "narrative": "1-2 sentence, past-tense description of what happened and its immediate effect",
  "updates": {{
    "dot.notation.path": value
  }}
}}

